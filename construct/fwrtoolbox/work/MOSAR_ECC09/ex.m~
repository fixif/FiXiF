%% Effect FWL

clc;
close all;
clear all;

Nbbits=11;


% initial filter
[num, den] =butter(3,[0.75 0.9]); % Filtre d'ordre 6
H=tf(num,den,-1);
[Aq,Bq,Cq,Dq] = tf2ss(H.num{1},H.den{1});
m=size(Aq,1);


% SSdelta (from DFIIq)
R1 = SSdelta2FWR( ss(Aq,Bq,Cq,Dq), 2^(-3));
R1 = setFPIS( R1, 32, 1, Nbbits, 32, 32, 32, 32, 32, 'RAM' );
[R1q, DeltaZ] = quantized( R1);


% balanced SS
[sysb,g] = balreal(ss(Aq,Bq,Cq,Dq));
R2 = SS2FWR( sysb);
R2 = setFPIS( R2, 32, 1, Nbbits, 32, 32, 32, 32, 32, 'RAM' );
[R2q, DeltaZ] = quantized( R2);


% Direct Form I q
R3 = DFIq2FWR( H )
R3 = setFPIS( R3, 32, 1, Nbbits, 32, 32, 32, 32, 32, 'RAM' );
[R3q, DeltaZ] = quantized( R3);


% plot
figure(1)
hold on;
AXIS([10^(-2) 10 -180 20])
bodemag(H)
bodemag(tf(R1q))
bodemag(tf(R2q))
bodemag(tf(R3q))
legend('H reference','forme SS en \delta','forme equilibree', 'forme directe I', '\rho-modal', 2 );
hold off;


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% Example in the end %%%%%%%%%%%%%%%%%%%%%%%



% Cascad form
[z p k]=zpkdata(H);

Z=z{1};
P=p{1};

 h1=tf(zpk([Z(1) Z(2)],[P(3) P(4)],1));
 h2=tf(zpk([Z(3) Z(4)],[P(5) P(6)],k));
 h3=tf(zpk([Z(5) Z(6)],[P(1) P(2)],1));

sys1=canon(h1, 'companion');
TR1 = SS2FWR(sys1.A,sys1.B,sys1.C,sys1.D);
sys2=canon(h2, 'companion');
TR2 = SS2FWR(sys2.A,sys2.B,sys2.C,sys2.D);
sys3=canon(h3, 'companion');
TR3 = SS2FWR(sys3.A,sys3.B,sys3.C,sys3.D);

R4=TR1*TR2*TR3;
R4= relaxedl2scaling(R4);

R4 = setFPIS( R4, 32, 1, Nbbits, 32, 32, 32, 32, 32, 'RAM' );
[R4q, DeltaZ] = quantized( R4);


% rho Direct Form II transposed
S= rhoDFIIt2FWS( H, [-0.8125 -0.75 -0.6875 -0.75 -0.75 -0.75], 1);
R5 = setFPIS( S.R, 32, 1, 11, 32, 32, 32, 32, 32, 'RAM' );
[R5q, DeltaZ] = quantized( R5);
bodemag(tf(R5q))

R_delta = Modaldelta2FWR( ss(H) );
R3 = setFPIS( R_delta, 32, 1, Nbbits, 32, 32, 32, 32, 32, 'RAM' );
[R3, DeltaZ] = quantized( R3);
bodemag(tf(R3))


R4=Modalrho2FWR (ss(H), [-0.5625 -0.6875 -0.8125 -0.9375 -0.625 -0.875],1);
R4 = setFPIS( R4, 32, 1, Nbits, 32, 32, 32, 32, 32, 'RAM' );
[R4, DeltaZ] = quantized( R4);
bodemag(tf(R4))


% plot
figure (2)
%R_q_s= relaxedl2scaling(R_q);
%bodemag(tf(R_q_s))
hold on;
AXIS([10^(-2) 10 -180 30])
bodemag(tf(H))
bodemag(tf(R4q))
legend('H reference','cascade form','\rho DFIIt', '\delta-modal', '\rho-modal', 2 );










