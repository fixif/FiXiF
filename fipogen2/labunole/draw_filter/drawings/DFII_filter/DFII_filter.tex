% Library for block diagrams and signal flow graphs
% Author: Matthias Hotz

\documentclass{article}

\usepackage{tikz}
\usetikzlibrary{dsp,chains}

\DeclareMathAlphabet{\mathpzc}{OT1}{pzc}{m}{it}
\newcommand{\z}{\mathpzc{z}}

\begin{document}

\centering

\begin{tikzpicture}

	% Place nodes using a matrix
	\matrix[row sep=2.5mm, column sep=10mm]
	{
		%--------------------------------------------------------------------
		\node[dspnodeopen,dsp/label=above]    (m00) {$u(k)$};    &
		\node[coordinate]                     (m01) {};          &
		\node[dspadder]                       (m02) {};          &
		\node[coordinate]                     (m03) {};          &
		\node[dspnodefull,dsp/label=aboveright]    (m04) {$e(k)$};    &
		\node[dsprtriangle]                   (m05) {$b_0$};     &
		\node[dspadder]                       (m06) {};          &
		\node[coordinate]                     (m07) {};          &
		\node[dspnodeopen,dsp/label=above]    (m08) {$y(k)$}; \\
		%--------------------------------------------------------------------
		\node[coordinate] (m10) {};&
		\node[coordinate] (m11) {};&
		\node[coordinate] (m12) {};&
		\node[coordinate] (m13) {}; &
		\node[dspsquare]  (m14) {$\z^{-1}$}; &
		\node[coordinate] (m15) {}; &
		\node[coordinate] (m16) {}; &
		\node[coordinate] (m17) {}; &
		\node[coordinate] (m18) {}; \\
		%--------------------------------------------------------------------
		\node[coordinate]                          (m20) {};          &
		\node[coordinate]                          (m21) {};          &
		\node[dspadder]                            (m22) {};          &
		\node[dspltriangle]                        (m23) {$-a_1$};    &
		\node[dspnodefull, dsp/label=aboveright]   (m24) {$e(k-1)$};  &
		\node[dsprtriangle]                        (m25) {$b_1$};     &
		\node[dspadder]                            (m26) {};          &
		\node[coordinate]                          (m27) {};          &
		\node[coordinate]                          (m28) {};          \\
		%--------------------------------------------------------------------
		% Could be automated
		\node[coordinate] (m30) {};&
		\node[coordinate] (m31) {};&
		\node[coordinate] (m32) {};&
		\node[coordinate] (m33) {}; &
		\node[dspsquare]  (m34) {$\z^{-1}$}; &
		\node[coordinate] (m35) {}; &
		\node[coordinate] (m36) {}; &
		\node[coordinate] (m37) {}; &
		\node[coordinate] (m38) {}; \\
		%--------------------------------------------------------------------
		\node[coordinate]                          (m40) {};          &
		\node[coordinate]                          (m41) {};          &
		\node[dspadder]                            (m42) {};          &
		\node[dspltriangle]                        (m43) {$-a_2$};    &
		\node[dspnodefull, dsp/label=aboveright]   (m44) {$e(k-2)$};  &
		\node[dsprtriangle]                        (m45) {$b_2$};     &
		\node[dspadder]                            (m46) {};          &
		\node[coordinate]                          (m47) {};          &
		\node[coordinate]                          (m48) {};          \\
		%--------------------------------------------------------------------
		% Could be automated
		\node[coordinate] (m50) {};&
		\node[coordinate] (m51) {};&
		\node[coordinate] (m52) {};&
		\node[coordinate] (m53) {}; &
		\node[dspsquare]  (m54) {$\z^{-1}$}; &
		\node[coordinate] (m55) {}; &
		\node[coordinate] (m56) {}; &
		\node[coordinate] (m57) {}; &
		\node[coordinate] (m58) {}; \\
		%
		\node[coordinate]                          (m60) {};          &
		\node[coordinate]                          (m61) {};          &
		\node[dspadder]                            (m62) {};          &
		\node[dspltriangle]                        (m63) {$-a_3$};    &
		\node[dspnodefull, dsp/label=aboveright]   (m64) {$e(k-3)$};  &
		\node[dsprtriangle]                        (m65) {$b_3$};     &
		\node[dspadder]                            (m66) {};          &
		\node[coordinate]                          (m67) {};          &
		\node[coordinate]                          (m68) {};          \\
		% space before last line
		\node[circle,draw=none]                    (m70) {};          &
		\node[circle,draw=none]                    (m71) {};          &
		\node[circle,draw=none]                    (m72) {};          &
		\node[circle,draw=none]                    (m73) {};          &
		\node[circle,draw=none]                    (m74) {};          &
		\node[circle,draw=none]                    (m75) {};          &
		\node[circle,draw=none]                    (m76) {};          &
		\node[circle,draw=none]                    (m77) {};          &
		\node[circle,draw=none]                    (m78) {};          \\
		%
		\node[coordinate] (m80) {};&
		\node[coordinate] (m81) {};&
		\node[coordinate] (m82) {};&
		\node[coordinate] (m83) {}; &
		\node[dspsquare]  (m84) {$\z^{-1}$}; &
		\node[coordinate] (m85) {}; &
		\node[coordinate] (m86) {}; &
		\node[coordinate] (m87) {}; &
		\node[coordinate] (m88) {}; \\
		%
		\node[coordinate]                          (m90) {};          &
		\node[coordinate]                          (m91) {};          &
		\node[coordinate]                          (m92) {};          &
		\node[dspltriangle]                        (m93) {$-a_n$};    &
		\node[dspnodefull, dsp/label=aboveright]   (m94) {$e(k-n)$};  &
		\node[dsprtriangle]                        (m95) {$b_n$};     &
		\node[coordinate]                          (m96) {};          &
		\node[coordinate]                          (m97) {};          &
		\node[coordinate]                          (m98) {};          \\
		%
	};

	% Draw connections
	
	\begin{scope}[start chain]
		\chainin (m00);
		\chainin (m02) [join=by dspconn];
		\chainin (m04) [join=by dspline];
		\chainin (m05) [join=by dspconn];
		\chainin (m06) [join=by dspconn];
		\chainin (m08) [join=by dspconn];
	\end{scope}
	%--------------------------------------------------------------------
	%Center, stage 1
	\begin{scope}[start chain]
		\chainin (m04);
		\chainin (m14) [join=by dspconn];
		\chainin (m24) [join=by dspline];
	\end{scope}

	%Left side, stage 1
	\begin{scope}[start chain]
		\chainin (m24);
		\chainin (m23) [join=by dspconn];
		\chainin (m22) [join=by dspconn];
		\chainin (m02) [join=by dspconn];
	\end{scope}
	
	%Right side, stage 1
	\begin{scope}[start chain]
		\chainin (m24);
		\chainin (m25) [join=by dspconn];
		\chainin (m26) [join=by dspconn];
		\chainin (m06) [join=by dspconn];
	\end{scope}
	%--------------------------------------------------------------------
	%Center, stage 2
	\begin{scope}[start chain]
	\chainin (m24);
	\chainin (m34) [join=by dspconn];
	\chainin (m44) [join=by dspline];
	\end{scope}
	
	%Left side, stage 2
	\begin{scope}[start chain]
		\chainin (m44);
		\chainin (m43) [join=by dspconn];
		\chainin (m42) [join=by dspconn];
		\chainin (m22) [join=by dspconn];
	\end{scope}
	
	%Right side, stage 2
	\begin{scope}[start chain]
		\chainin (m44);
		\chainin (m45) [join=by dspconn];
		\chainin (m46) [join=by dspconn];
		\chainin (m26) [join=by dspconn];
	\end{scope}
	%--------------------------------------------------------------------
	%Center, stage 3
	\begin{scope}[start chain]
	\chainin (m44);
	\chainin (m54) [join=by dspconn];
	\chainin (m64) [join=by dspline];
	\end{scope}
	
	%Left side, stage 2
	\begin{scope}[start chain]
		\chainin (m64);
		\chainin (m63) [join=by dspconn];
		\chainin (m62) [join=by dspconn];
		\chainin (m42) [join=by dspconn];
	\end{scope}
	
	%Right side, stage 2
	\begin{scope}[start chain]
		\chainin (m64);
		\chainin (m65) [join=by dspconn];
		\chainin (m66) [join=by dspconn];
		\chainin (m46) [join=by dspconn];
	\end{scope}
	%--------------------------------------------------------------------
	%Center, stage "n"
	\begin{scope}[start chain]
	\chainin (m64);
	\chainin (m84) [join=by dspdconn];
	\chainin (m94) [join=by dspline];
	\end{scope}
	
	%Left side, stage "n"
	\begin{scope}[start chain]
		\chainin (m94);
		\chainin (m93) [join=by dspconn];
		\chainin (m92) [join=by dspline];
		\chainin (m82) [join=by dspline];
	\end{scope}
	
	%Right side, stage "n"
	\begin{scope}[start chain]
		\chainin (m94);
		\chainin (m95) [join=by dspconn];
		\chainin (m96) [join=by dspline];
		\chainin (m86) [join=by dspline];
	\end{scope}
	%--------------------------------------------------------------------
	% Continuation, right side
	\begin{scope}[start chain]
		\chainin (m86);
		
		\chainin (m66) [join=by dspdconn];
	\end{scope}
	
	% Continuation, left side
	\begin{scope}[start chain]
		\chainin (m82);
		\chainin (m62) [join=by dspdconn];
	\end{scope}

\end{tikzpicture}

\end{document}
