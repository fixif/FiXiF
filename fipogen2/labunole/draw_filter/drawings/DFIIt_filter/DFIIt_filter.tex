% Library for block diagrams and signal flow graphs
% Author: Matthias Hotz

\documentclass{article}

\usepackage{tikz}
\usetikzlibrary{dsp,chains,positioning}

\DeclareMathAlphabet{\mathpzc}{OT1}{pzc}{m}{it}
\newcommand{\z}{\mathpzc{z}}

\begin{document}

\centering

\begin{tikzpicture}

	% Place nodes using a matrix
	\matrix[row sep=2.5mm, column sep=10mm]
	{
		%--------------------------------------------------------------------
		\node[dspnodeopen,dsp/label=left]    (m00) {$y(k)$};    &
		\node[coordinate]               (m01) {};          &
		\node[coordinate]                     (m02) {};          &
		\node[dspadder]                       (m03) {};          &
		\node[dspltriangle]                   (m04) {$b_0$};    &
		\node[coordinate]               (m05) {};     &
		\node[dspnodeopen,dsp/label=right]    (m06) {$u(k)$}; \\
		%--------------------------------------------------------------------
		%Line with signal nodes
		% Space set manually
		\node[coordinate] (m10) {};&
		\node[coordinate] (m11) {};&
		\node[coordinate] (m12) {};&
		\node[coordinate] (m13) {}; &
		\node[coordinate] (m14) {}; &
		\node[coordinate] (m15) {}; &
		\node[coordinate] (m16) {}; \\
		%--------------------------------------------------------------------
		\node[coordinate]      (m20) {};          &
		\node[coordinate]      (m21) {};          &
		\node[coordinate]      (m22) {};          &
		\node[dspsquare]       (m23) {$\z^{-1}$};  &
		\node[coordinate]      (m24) {};          &
		\node[coordinate]      (m25) {};          &
		\node[coordinate]      (m26) {};          \\
		%--------------------------------------------------------------------
		\node[coordinate] (m30) {};&
		\node[coordinate] (m31) {};&
		\node[dsprtriangle] (m32) {$-a_1$};&
		\node[dspadder] (m33) {}; &
		\node[dspltriangle]  (m34) {$b_1$}; &
		\node[coordinate] (m35) {}; &
		\node[coordinate] (m36) {}; \\
		%--------------------------------------------------------------------
		%Line with signal nodes
		% Space set manually
		\node[coordinate] (m40) {};&
		\node[coordinate] (m41) {};&
		\node[coordinate] (m42) {};&
		\node[coordinate] (m43) {};&
		\node[coordinate] (m44) {}; &
		\node[coordinate] (m45) {}; &
		\node[coordinate] (m46) {}; \\
		%--------------------------------------------------------------------
		\node[coordinate]      (m50) {};          &
		\node[coordinate]      (m51) {};          &
		\node[coordinate]      (m52) {};          &
		\node[dspsquare]       (m53) {$\z^{-1}$};  &
		\node[coordinate]      (m54) {};          &
		\node[coordinate]      (m55) {};          &
		\node[coordinate]      (m56) {};          \\
		%--------------------------------------------------------------------
		\node[coordinate]         (m60) {};&
		\node[coordinate]   (m61) {};&
		\node[dsprtriangle]       (m62) {$-a_2$};&
		\node[dspadder]           (m63) {}; &
		\node[dspltriangle]       (m64) {$b_2$}; &
		\node[coordinate]   (m65) {}; &
		\node[coordinate]         (m66) {}; \\
		%--------------------------------------------------------------------
		% Points in middle of dotted/nondotted line
		\node[coordinate]            (m70) {};          &
		\node[coordinate]      (m71) {};          &
		\node[coordinate]      (m72) {};          &
		\node[coordinate]       (m73) {};  &
		\node[coordinate]      (m74) {};          &
		\node[coordinate]      (m75) {};          &
		\node[coordinate]      (m76) {};          \\
		%--------------------------------------------------------------------
		%Line with signal nodes
		% Space set manually
		\node[coordinate] (m80) {};&
		\node[coordinate] (m81) {};&
		\node[coordinate] (m82) {};&
		\node[coordinate] (m83) {};&
		\node[coordinate] (m84) {}; &
		\node[coordinate] (m85) {}; &
		\node[coordinate] (m86) {}; \\
		%--------------------------------------------------------------------
		\node[coordinate]      (m90) {};          &
		\node[coordinate]      (m91) {};          &
		\node[coordinate]      (m92) {};          &
		\node[dspsquare]       (m93) {$\z^{-1}$};  &
		\node[coordinate]      (m94) {};          &
		\node[coordinate]      (m95) {};          &
		\node[coordinate]      (m96) {};          \\
		%--------------------------------------------------------------------
		\node[coordinate]         (m100) {};&
		\node[coordinate]   (m101) {};&
		\node[dsprtriangle]       (m102) {$-a_n$};&
		\node[dspadder]           (m103) {}; &
		\node[dspltriangle]       (m104) {$b_n$}; &
		\node[coordinate]   (m105) {}; &
		\node[coordinate]         (m106) {}; \\
		%--------------------------------------------------------------------
	};
	%--------------------------------------------------------------------
	\node[dspnodefull, dsp/label=aboveright,above = -0.1cm of m23] (ms1) {$s_1(k,...,k-n)$}; % hack should be - \dspnoderadius/2
	\node[dspnodefull, dsp/label=aboveright,above= -0.1cm of m53] (ms2) {$s_2(k,...,k-n-1)$};
	\node[dspnodefull, dsp/label=aboveright,above= -0.1cm of m93] (ms3) {$e(k-1)$};
	\node[dspnodefull, dsp/label=belowright,below= -0.1cm of m93] (ms3) {$e(k)$};
	% horizontal, line 0
	%--------------------------------------------------------------------
	% Horizontal, left line
	\begin{scope}[start chain]
		\chainin (m06);
		\chainin (m05) [join=by dspline];
		\chainin (m04) [join=by dspline];
		\chainin (m03) [join=by dspconn];
		\chainin (m01) [join=by dspline];
		\chainin (m00) [join=by dspconn];
	\end{scope}
	%--------------------------------------------------------------------
	%Vertical, right line
	\begin{scope}[start chain]
		\chainin (m05);
		\chainin (m25) [join=by dspconn];
		\chainin (m55) [join=by dspline];
		\chainin (m75) [join=by dspline];
		\chainin (m95) [join=by dspdline];
		\chainin (m105) [join=by dspline];
	\end{scope}
	%--------------------------------------------------------------------
	%Vertical, left line
	\begin{scope}[start chain]
		\chainin (m01);
		\chainin (m21) [join=by dspconn];
		\chainin (m51) [join=by dspline];
		\chainin (m71) [join=by dspline];
		\chainin (m91) [join=by dspdline];
		\chainin (m101) [join=by dspline];
	\end{scope}
	%--------------------------------------------------------------------
	%a1b1 line right side
	\begin{scope}[start chain]
		\chainin (m35);
		\chainin (m34) [join=by dspline];
		\chainin (m33) [join=by dspconn];
	\end{scope}
	%a1b1 left side
	\begin{scope}[start chain]
		\chainin (m31);
		\chainin (m32) [join=by dspline];
		\chainin (m33) [join=by dspconn];
	\end{scope}
 	%--------------------------------------------------------------------
	%a2b2 RS
	\begin{scope}[start chain]
		\chainin (m65);
		\chainin (m64) [join=by dspline];
		\chainin (m63) [join=by dspconn];
	\end{scope}
	%a2b2 LS
	\begin{scope}[start chain]
		\chainin (m61);
		\chainin (m62) [join=by dspline];
		\chainin (m63) [join=by dspconn];
	\end{scope}
	%--------------------------------------------------------------------
	%anbn RS
	\begin{scope}[start chain]
		\chainin (m105);
		\chainin (m104) [join=by dspline];
		\chainin (m103) [join=by dspconn];
	\end{scope}
	%anbn LS
	\begin{scope}[start chain]
		\chainin (m101);
		\chainin (m102) [join=by dspline];
		\chainin (m103) [join=by dspconn];
	\end{scope}
 	%--------------------------------------------------------------------
 	% Center line
 	\begin{scope}[start chain]
		\chainin (m103);
		\chainin (m93) [join=by dspconn];
		\chainin (m83) [join=by dspline];
		\chainin (m63) [join=by dspdconn];
		\chainin (m53) [join=by dspconn];
		\chainin (m43) [join=by dspline];
		\chainin (m33) [join=by dspconn];
		\chainin (m23) [join=by dspconn];
		\chainin (m13) [join=by dspline];
		\chainin (m03) [join=by dspconn];
 	\end{scope}
	
% 	%Center, stage 1
% 	\begin{scope}[start chain]
% 		\chainin (m04);
% 		\chainin (m14) [join=by dspconn];
% 		\chainin (m24) [join=by dspline];
% 	\end{scope}
% 
% 	%Left side, stage 1
% 	\begin{scope}[start chain]
% 		\chainin (m24);
% 		\chainin (m23) [join=by dspconn];
% 		\chainin (m22) [join=by dspconn];
% 		\chainin (m02) [join=by dspconn];
% 	\end{scope}
% 	
% 	%Right side, stage 1
% 	\begin{scope}[start chain]
% 		\chainin (m24);
% 		\chainin (m25) [join=by dspconn];
% 		\chainin (m26) [join=by dspconn];
% 		\chainin (m06) [join=by dspconn];
% 	\end{scope}
% 	%--------------------------------------------------------------------
% 	%Center, stage 2
% 	\begin{scope}[start chain]
% 	\chainin (m24);
% 	\chainin (m34) [join=by dspconn];
% 	\chainin (m44) [join=by dspline];
% 	\end{scope}
% 	
% 	%Left side, stage 2
% 	\begin{scope}[start chain]
% 		\chainin (m44);
% 		\chainin (m43) [join=by dspconn];
% 		\chainin (m42) [join=by dspconn];
% 		\chainin (m22) [join=by dspconn];
% 	\end{scope}
% 	
% 	%Right side, stage 2
% 	\begin{scope}[start chain]
% 		\chainin (m44);
% 		\chainin (m45) [join=by dspconn];
% 		\chainin (m46) [join=by dspconn];
% 		\chainin (m26) [join=by dspconn];
% 	\end{scope}
% 	%--------------------------------------------------------------------
% 	%Center, stage 3
% 	\begin{scope}[start chain]
% 	\chainin (m44);
% 	\chainin (m54) [join=by dspconn];
% 	\chainin (m64) [join=by dspline];
% 	\end{scope}
% 	
% 	%Left side, stage 2
% 	\begin{scope}[start chain]
% 		\chainin (m64);
% 		\chainin (m63) [join=by dspconn];
% 		\chainin (m62) [join=by dspconn];
% 		\chainin (m42) [join=by dspconn];
% 	\end{scope}
% 	
% 	%Right side, stage 2
% 	\begin{scope}[start chain]
% 		\chainin (m64);
% 		\chainin (m65) [join=by dspconn];
% 		\chainin (m66) [join=by dspconn];
% 		\chainin (m46) [join=by dspconn];
% 	\end{scope}
% 	%--------------------------------------------------------------------
% 	%Center, stage "n"
% 	\begin{scope}[start chain]
% 	\chainin (m64);
% 	\chainin (m84) [join=by dspdconn];
% 	\chainin (m94) [join=by dspline];
% 	\end{scope}
% 	
% 	%Left side, stage "n"
% 	\begin{scope}[start chain]
% 		\chainin (m94);
% 		\chainin (m93) [join=by dspconn];
% 		\chainin (m92) [join=by dspline];
% 		\chainin (m82) [join=by dspline];
% 	\end{scope}
% 	
% 	%Right side, stage "n"
% 	\begin{scope}[start chain]
% 		\chainin (m94);
% 		\chainin (m95) [join=by dspconn];
% 		\chainin (m96) [join=by dspline];
% 		\chainin (m86) [join=by dspline];
% 	\end{scope}
% 	%--------------------------------------------------------------------
% 	% Continuation, right side
% 	\begin{scope}[start chain]
% 		\chainin (m86);
% 		
% 		\chainin (m66) [join=by dspdconn];
% 	\end{scope}
% 	
% 	% Continuation, left side
% 	\begin{scope}[start chain]
% 		\chainin (m82);
% 		\chainin (m62) [join=by dspdconn];
% 	\end{scope}

\end{tikzpicture}

\end{document}
